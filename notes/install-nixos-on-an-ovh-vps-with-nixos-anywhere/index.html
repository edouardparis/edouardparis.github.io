<!doctype html><html><head><title>edouard.paris</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><meta name=description content="Edouard Paris personal website"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css><link rel=stylesheet type=text/css href=/css/main.css></head><body><main><div class=article-header><a href=https://edouard.paris>~/edouard.paris</a><a href=https://edouard.paris/notes>/notes</a><a>/install-nixOs-on-an-ovh-vps-with-nixos-anywhere</a></div><aside class=head-aside><div class=sidenote>created: Jan 15 2024<br>updated: Jan 15 2024<br><br>Read this page in your terminal with the command:<br><strong>$ curl -L
edouard.paris/notes/install-nixos-on-an-ovh-vps-with-nixos-anywhere/index.txt | less</strong><br></div></aside><section><div class=article-body><h1 id=install-nixos-on-an-ovh-vps-with-nixos-anywhere>Install NixOs on an OVH vps with nixos-anywhere</h1><p>2023 was the year I was nix pilled. 2024 is the year for the experimentations.
I discovered the power of NixOs for server deployment with this talk from
Carl Dong: <a href="https://www.youtube.com/watch?v=bKTbis4elR8&amp;t=5519s">The dark arts of NixOs deployments</a>.</p><aside><div class=sidenote>In his talk, Carl referenced a
<a href=https://www.haskellforall.com/2023/01/announcing-nixos-rebuild-new-deployment.html>blog post from Haskell for all</a>
about nixos-rebuild usage for deployment.</div></aside><p>He talked about the new nixos-rebuild command to easily change and deploy the
configuration of a server and how using <a href=https://www.man7.org/linux/man-pages/man8/kexec.8.html>kexec(8)</a>
and <a href=https://github.com/nix-community/disko>disko</a>
to install NixOs on it without the <a href=https://github.com/elitak/nixos-infect>nixos-infect</a> scripts
(which are more a hack than a clean way to do it).</p><p>This inevitably leads me to <a href=https://github.com/nix-community/nixos-anywhere>nixos-anywhere</a>
a great tool using kexec and disko to deploy custom flakes !</p><p>The repository gives an example using Hetzner vps provider, but I wanted to try to install
nixos on an OVH vps. Here a quick guide of how I did it:</p><h2 id=1-create-vps-and-get-credentials>1. Create vps and get credentials</h2><ul><li>Create an ovh account</li><li>Order vps with debian 12</li><li>Ovh send to you email with id, ip, and link to create a password</li></ul><p>you can connect with <code>ssh debian@&lt;vps-ip></code>.</p><h2 id=2-change-password-with-passwd-and-add-ssh-key-to-authorized-keys>2. Change password with <code>passwd</code> and add ssh key to authorized keys.</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#444>$</span> sudo vim /root/.ssh/authorized_keys
</span></span><span style=display:flex><span><span style=color:#444>$</span> sudo systemctl restart ssh
</span></span></code></pre></div><h2 id=3-install-nix>3. Install nix</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#444>$</span> sh &lt;<span style=color:#666>(</span>curl -L https://nixos.org/nix/install<span style=color:#666>)</span> --daemon
</span></span></code></pre></div><p>Nix won&rsquo;t work in active console sessions until you restart them.
exit and reconnect in a new root ssh session.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#444>$</span> nix-env -iE <span style=color:#b83838>&#34;_: with import &lt;nixpkgs/nixos&gt; { configuration = {}; }; \
</span></span></span><span style=display:flex><span><span style=color:#b83838></span><span style=color:#666>  with config.system.build; [ nixos-generate-config ]&#34;
</span></span></span><span style=display:flex><span><span style=color:#666></span><span style=background-color:#a848a8>
</span></span></span><span style=display:flex><span><span style=background-color:#a848a8></span><span style=color:#444>$</span> nixos-generate-config --no-filesystems --root /mnt
</span></span></code></pre></div><p>Copy from <code>/mnt</code> the <code>hardware-configuration.nix</code> file.</p><p>The rest of the commands should be done on your local machine and not on the target host.</p><h2 id=4-prepare-flake>4. Prepare flake</h2><p>You can find an example of the flake <a href=https://github.com/edouardparis/nixos-ovh-vps-example>here</a>.
Change the <code>hardware-configuration.nix</code> file with the one you copied and change <code>disk-config.nix</code></p><h2 id=5-test-flake>5. Test flake</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#444>$</span> nix run github:nix-community/nixos-anywhere -- --flake .#ovh-vps --vm-test
</span></span></code></pre></div><h2 id=6-load-nixos-anywhere>6. Load nixos-anywhere</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#444>$</span> nix run github:nix-community/nixos-anywhere -- --flake .#ovh-vps root@&lt;vps-ip&gt;
</span></span></code></pre></div><h2 id=7-reload-configuration>7. Reload configuration</h2><p>Add <code>screenfetch</code> to the flake configuration.nix <code>environment.systemPackages</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#444>$</span> nixos-rebuild switch --flake .#ovh-vps --target-host <span style=color:#b83838>&#34;root@&lt;vps-ip&gt;&#34;</span>
</span></span></code></pre></div><p>Connect to the host</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#444>$</span> ssh root@&lt;vps-ip&gt;
</span></span><span style=display:flex><span><span style=color:#666>Last login: Tue Jan  2 15:18:52 2024 from &lt;ip&gt;
</span></span></span></code></pre></div><p>then check that the <code>screenfetch</code> package was installed.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#444>[root@nixos:~]#</span> screenfetch
</span></span><span style=display:flex><span><span style=color:#666>          ::::.    &#39;:::::     ::::&#39;         root@nixos
</span></span></span><span style=display:flex><span><span style=color:#666>          &#39;:::::    &#39;:::::.  ::::&#39;          OS: NixOS 24.05.20231221.d6863cb
</span></span></span><span style=display:flex><span><span style=color:#666>            :::::     &#39;::::.:::::           Kernel: x86_64 Linux 6.1.69
</span></span></span><span style=display:flex><span><span style=color:#666>      .......:::::..... ::::::::            Uptime: 7m
</span></span></span><span style=display:flex><span><span style=color:#666>     ::::::::::::::::::. ::::::    ::::.    Packages: 470
</span></span></span><span style=display:flex><span><span style=color:#666>    ::::::::::::::::::::: :::::.  .::::&#39;    Shell: bash 5.2.21
</span></span></span><span style=display:flex><span><span style=color:#666>           .....           ::::&#39; :::::&#39;     Disk: 1.1G / 20G (6%)
</span></span></span><span style=display:flex><span><span style=color:#666>          :::::            &#39;::&#39; :::::&#39;      CPU: Intel Core (Haswell, no TSX)
</span></span></span><span style=display:flex><span><span style=color:#666> ........:::::               &#39; :::::::::::. GPU: Cirrus Logic GD 5446
</span></span></span><span style=display:flex><span><span style=color:#666>:::::::::::::                 ::::::::::::: RAM: 250MiB / 1935MiB
</span></span></span><span style=display:flex><span><span style=color:#666> ::::::::::: ..              :::::           
</span></span></span><span style=display:flex><span><span style=color:#666>     .::::: .:::            :::::            
</span></span></span><span style=display:flex><span><span style=color:#666>    .:::::  :::::          &#39;&#39;&#39;&#39;&#39;    .....    
</span></span></span><span style=display:flex><span><span style=color:#666>    :::::   &#39;:::::.  ......:::::::::::::&#39;    
</span></span></span><span style=display:flex><span><span style=color:#666>     :::     ::::::. &#39;:::::::::::::::::&#39;     
</span></span></span><span style=display:flex><span><span style=color:#666>            .:::::::: &#39;::::::::::            
</span></span></span><span style=display:flex><span><span style=color:#666>           .::::&#39;&#39;::::.     &#39;::::.           
</span></span></span><span style=display:flex><span><span style=color:#666>          .::::&#39;   ::::.     &#39;::::.          
</span></span></span><span style=display:flex><span><span style=color:#666>         .::::      ::::      &#39;::::.         
</span></span></span></code></pre></div><p>The Nixos VPS is ready ! Modify and reload configuration as you will ! ❄️</p></div></section><footer id=footer>&copy; 2024 EdouardParis. Powered by <a href=http://gohugo.io target=_blank>Hugo</a></footer></main></body></html>